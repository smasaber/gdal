<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>GDAL: OGR Driver Implementation Tutorial</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">GDAL
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="usergroup0.html"><span>Download</span></a></li>
      <li><a href="https://github.com/OSGeo/gdal/issues/"><span>Issue&#160;Tracker</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">OGR Driver Implementation Tutorial </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="odt_overall"></a>
Overall Approach</h1>
<p>In general new formats are added to OGR by implementing format specific drivers with instantiating a <a class="el" href="classGDALDriver.html" title="Format specific driver. ">GDALDriver</a> and subclasses of <a class="el" href="classGDALDataset.html" title="A set of associated raster bands, usually from one file. ">GDALDataset</a> and <a class="el" href="classOGRLayer.html" title="This class represents a layer of simple features, with access methods. ">OGRLayer</a>. The <a class="el" href="classGDALDriver.html" title="Format specific driver. ">GDALDriver</a> instance is registered with the <a class="el" href="classGDALDriverManager.html" title="Class for managing the registration of file format drivers. ">GDALDriverManager</a> at runtime.</p>
<p>Before following this tutorial to implement an OGR driver, please review the <a href="ogr_arch.html">OGR Architecture</a> document carefully.</p>
<p>The tutorial will be based on implementing a simple ascii point format.</p>
<h1><a class="anchor" id="odt_toc"></a>
Contents</h1>
<ol>
<li>
<a class="el" href="ogr_drivertut.html#odt_driver_ro">Implementing GDALDriver</a> </li>
<li>
<a class="el" href="ogr_drivertut.html#odt_datasource_bro">Basic Read Only Data Source</a> </li>
<li>
<a class="el" href="ogr_drivertut.html#odt_layer_bro">Read Only Layer</a> </li>
</ol>
<h1><a class="anchor" id="odt_driver_ro"></a>
Implementing GDALDriver</h1>
<p>The format specific driver class is implemented as a instance of <a class="el" href="classGDALDriver.html" title="Format specific driver. ">GDALDriver</a>. One instance of the driver will normally be created, and registered with the <a class="el" href="classGDALDriverManager.html" title="Class for managing the registration of file format drivers. ">GDALDriverManager</a>. The instantiation of the driver is normally handled by a global C callable registration function, similar to the following placed in the same file as the driver class.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> RegisterOGRSPF()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span>( <a class="code" href="gdal_8h.html#ae8ae868eef1e4773283d137b0a1adfc4">GDALGetDriverByName</a>(<span class="stringliteral">&quot;SPF&quot;</span>) != NULL )</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classGDALDriver.html">GDALDriver</a> *poDriver = <span class="keyword">new</span> <a class="code" href="classGDALDriver.html">GDALDriver</a>();</div>
<div class="line"></div>
<div class="line">    poDriver-&gt;<a class="code" href="classGDALMajorObject.html#af334bc8d152f130a55783ea36938735b">SetDescription</a>(<span class="stringliteral">&quot;SPF&quot;</span>);</div>
<div class="line">    poDriver-&gt;<a class="code" href="classGDALDriver.html#a65130ea5fe7ea188b9c666080ea4ad30">SetMetadataItem</a>(<a class="code" href="gdal_8h.html#ab53ff698bf4673223ebbdb09b33ac4ba">GDAL_DCAP_VECTOR</a>, <span class="stringliteral">&quot;YES&quot;</span>);</div>
<div class="line">    poDriver-&gt;<a class="code" href="classGDALDriver.html#a65130ea5fe7ea188b9c666080ea4ad30">SetMetadataItem</a>(<a class="code" href="gdal_8h.html#a10963a08bd12bf29b36d8a23fb45471f">GDAL_DMD_LONGNAME</a>, <span class="stringliteral">&quot;Long name for SPF driver&quot;</span>);</div>
<div class="line">    poDriver-&gt;<a class="code" href="classGDALDriver.html#a65130ea5fe7ea188b9c666080ea4ad30">SetMetadataItem</a>(<a class="code" href="gdal_8h.html#aebd79c9d69709cc61c0329fa2298fe18">GDAL_DMD_EXTENSION</a>, <span class="stringliteral">&quot;spf&quot;</span>);</div>
<div class="line">    poDriver-&gt;<a class="code" href="classGDALDriver.html#a65130ea5fe7ea188b9c666080ea4ad30">SetMetadataItem</a>(<a class="code" href="gdal_8h.html#a85442e30b5313c88213ba87bf1b1ef05">GDAL_DMD_HELPTOPIC</a>, <span class="stringliteral">&quot;drv_spf.html&quot;</span>);</div>
<div class="line"></div>
<div class="line">    poDriver-&gt;pfnOpen = OGRSPFDriverOpen;</div>
<div class="line">    poDriver-&gt;pfnIdentify = OGRSPFDriverIdentify;</div>
<div class="line">    poDriver-&gt;pfnCreate = OGRSPFDriverCreate;</div>
<div class="line"></div>
<div class="line">    poDriver-&gt;<a class="code" href="classGDALDriver.html#a65130ea5fe7ea188b9c666080ea4ad30">SetMetadataItem</a>(<a class="code" href="gdal_8h.html#ad1f10e72385fed566d178dc3f0067fb8">GDAL_DCAP_VIRTUALIO</a>, <span class="stringliteral">&quot;YES&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="gdal__priv_8h.html#a4fb74d15f12b1ecd77bd8e5c48086590">GetGDALDriverManager</a>()-&gt;<a class="code" href="classGDALDriverManager.html#aa33cc86affa255ac37b463c129fbe49f">RegisterDriver</a>(poDriver);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The SetDescription() sets the name of the driver. This name is specified on the commandline when creating datasources so it is generally good to keep it short and without any special characters or spaces.</p>
<p>SetMetadataItem( GDAL_DCAP_VECTOR, "YES" ) is specified to indicate that the driver will handle vector data.</p>
<p>SetMetadataItem( GDAL_DCAP_VIRTUALIO, "YES" ) is specified to indicate that the driver can deal with files opened with the VSI*L GDAL API. Otherwise this metadata item should not be defined.</p>
<p>The driver declaration generally looks something like this for a format with read or read and update access (the Open() method) and creation support (the Create() method).</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="classGDALDataset.html">GDALDataset</a>* OGRSPFDriverOpen(<a class="code" href="classGDALOpenInfo.html">GDALOpenInfo</a>* poOpenInfo);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span>          OGRSPFDriverIdentify(<a class="code" href="classGDALOpenInfo.html">GDALOpenInfo</a>* poOpenInfo);</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="classGDALDataset.html">GDALDataset</a>* OGRSPFDriverCreate(<span class="keyword">const</span> <span class="keywordtype">char</span>* pszName, <span class="keywordtype">int</span> nXSize, <span class="keywordtype">int</span> nYSize,</div>
<div class="line">                                       <span class="keywordtype">int</span> nBands, <a class="code" href="gdal_8h.html#a22e22ce0a55036a96f652765793fb7a4">GDALDataType</a> eDT, <span class="keywordtype">char</span>** papszOptions);</div>
</div><!-- fragment --><p>The Open() method is called by <a class="el" href="gdal_8h.html#aca05455472359964151f9c891d678d5e" title="Open a raster or vector file as a GDALDataset. ">GDALOpenEx()</a>. It should quietly return NULL if the passed filename is not of the format supported by the driver. If it is the target format, then a new <a class="el" href="classGDALDataset.html" title="A set of associated raster bands, usually from one file. ">GDALDataset</a> object for the dataset should be returned.</p>
<p>It is common for the Open() method to be delegated to an Open() method on the actual format's <a class="el" href="classGDALDataset.html" title="A set of associated raster bands, usually from one file. ">GDALDataset</a> class.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="classGDALDataset.html">GDALDataset</a> *OGRSPFDriverOpen( <a class="code" href="classGDALOpenInfo.html">GDALOpenInfo</a>* poOpenInfo )</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span>( !OGRSPFDriverIdentify(poOpenInfo) )</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line"></div>
<div class="line">    OGRSPFDataSource *poDS = <span class="keyword">new</span> OGRSPFDataSource();</div>
<div class="line">    <span class="keywordflow">if</span>( !poDS-&gt;Open(poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#ac4853cfc89944973b4811a7422d20837">pszFilename</a>, poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#a720dbd5edc6176843b2e73d21c9cf23c">eAccess</a> == <a class="code" href="gdal_8h.html#a045e3967c208993f70257bfd40c9f1d7a61c6081de474ef2a756982d3c53130a2">GA_Update</a>) )</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">delete</span> poDS;</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> poDS;</div>
<div class="line">}</div>
</div><!-- fragment --><p>The Identify() method is implemented as such :</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> OGRSPFDriverIdentify( <a class="code" href="classGDALOpenInfo.html">GDALOpenInfo</a>* poOpenInfo )</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Does this appear to be an .spf file?</span></div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="cpl__port_8h.html#a8eb7da27bde11ccd5bf0c204ad32fb89">EQUAL</a>(<a class="code" href="cpl__conv_8h.html#ad7282f4e659cb5f8b5566bec1ed44fe1">CPLGetExtension</a>(poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#ac4853cfc89944973b4811a7422d20837">pszFilename</a>), <span class="stringliteral">&quot;spf&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Examples of the Create() method is left for the section on creation and update.</p>
<h1><a class="anchor" id="odt_datasource_bro"></a>
Basic Read Only Data Source</h1>
<p>We will start implementing a minimal read-only datasource. No attempt is made to optimize operations, and default implementations of many methods inherited from <a class="el" href="classGDALDataset.html" title="A set of associated raster bands, usually from one file. ">GDALDataset</a> are used.</p>
<p>The primary responsibility of the datasource is to manage the list of layers. In the case of the SPF format a datasource is a single file representing one layer so there is at most one layer. The "name" of a datasource should generally be the name passed to the Open() method.</p>
<p>The Open() method below is not overriding a base class method, but we have it to implement the open operation delegated by the driver class.</p>
<p>For this simple case we provide a stub TestCapability() that returns FALSE for all extended capabilities. The TestCapability() method is pure virtual, so it does need to be implemented.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>OGRSPFDataSource : <span class="keyword">public</span> <a class="code" href="classGDALDataset.html">GDALDataset</a></div>
<div class="line">{</div>
<div class="line">    OGRSPFLayer       **papoLayers;</div>
<div class="line">    <span class="keywordtype">int</span>                 nLayers;</div>
<div class="line"></div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">                        OGRSPFDataSource();</div>
<div class="line">                        ~OGRSPFDataSource();</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span>                 <a class="code" href="classGDALDataset.html#a5379df6aeeebe76a985365acaeab756d">Open</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> *pszFilename, <span class="keywordtype">int</span> bUpdate );</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span>                 <a class="code" href="classGDALDataset.html#a1cf5c6be551f8e16b0c0f677789b188d">GetLayerCount</a>() { <span class="keywordflow">return</span> nLayers; }</div>
<div class="line">    <a class="code" href="classOGRLayer.html">OGRLayer</a>            *<a class="code" href="classGDALDataset.html#a8e97c359216425a5d8fc4a8ef5b314d0">GetLayer</a>( <span class="keywordtype">int</span> );</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span>                 <a class="code" href="classGDALDataset.html#ae2eee7686621c516581a415822d83b2a">TestCapability</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> * ) { <span class="keywordflow">return</span> FALSE; }</div>
<div class="line">};</div>
</div><!-- fragment --><p>The constructor is a simple initializer to a default state. The Open() will take care of actually attaching it to a file. The destructor is responsible for orderly cleanup of layers.</p>
<div class="fragment"><div class="line">OGRSPFDataSource::OGRSPFDataSource()</div>
<div class="line">{</div>
<div class="line">    papoLayers = NULL;</div>
<div class="line">    nLayers = 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">OGRSPFDataSource::~OGRSPFDataSource()</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; nLayers; i++ )</div>
<div class="line">        <span class="keyword">delete</span> papoLayers[i];</div>
<div class="line">    <a class="code" href="cpl__conv_8h.html#a21b7f312da39ddb0a12bdde06b153b48">CPLFree</a>(papoLayers);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The Open() method is the most important one on the datasource, though in this particular instance it passes most of its work off to the OGRSPFLayer constructor if it believes the file is of the desired format.</p>
<p>Note that Open() methods should try and determine that a file isn't of the identified format as efficiently as possible, since many drivers may be invoked with files of the wrong format before the correct driver is reached. In this particular Open() we just test the file extension but this is generally a poor way of identifying a file format. If available, checking "magic header values" or something similar is preferable.</p>
<p>In the case of the SPF format, update in place is not supported, so we always fail if bUpdate is FALSE.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span>  OGRSPFDataSource::Open( <span class="keyword">const</span> <span class="keywordtype">char</span> *pszFilename, <span class="keywordtype">int</span> bUpdate )</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span>( bUpdate )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="cpl__error_8h.html#afda4d86428c1c533449ae6a69cdf430d">CPLError</a>(CE_Failure, <a class="code" href="cpl__error_8h.html#a730735f3bab3514071f6a8642910ea75">CPLE_OpenFailed</a>,</div>
<div class="line">                 <span class="stringliteral">&quot;Update access not supported by the SPF driver.&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> FALSE;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create a corresponding layer.</span></div>
<div class="line">    nLayers = 1;</div>
<div class="line">    papoLayers = <span class="keyword">static_cast&lt;</span>OGRSPFLayer **<span class="keyword">&gt;</span>(<a class="code" href="cpl__conv_8h.html#a9a806de98fbddb1337efdb18651aa0f7">CPLMalloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *)));</div>
<div class="line"></div>
<div class="line">    papoLayers[0] = <span class="keyword">new</span> OGRSPFLayer(pszFilename);</div>
<div class="line"></div>
<div class="line">    pszName = <a class="code" href="cpl__conv_8h.html#a0430cfd9565379fa7c9452316c863c07">CPLStrdup</a>(pszFilename);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> TRUE;</div>
<div class="line">}</div>
</div><!-- fragment --><p>A GetLayer() method also needs to be implemented. Since the layer list is created in the Open() this is just a lookup with some safety testing.</p>
<div class="fragment"><div class="line"><a class="code" href="classOGRLayer.html">OGRLayer</a> *OGRSPFDataSource::GetLayer( <span class="keywordtype">int</span> iLayer )</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span>( iLayer &lt; 0 || iLayer &gt;= nLayers )</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> papoLayers[iLayer];</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="odt_layer_bro"></a>
Read Only Layer</h1>
<p>The OGRSPFLayer is implements layer semantics for an .spf file. It provides access to a set of feature objects in a consistent coordinate system with a particular set of attribute columns. Our class definition looks like this:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>OGRSPFLayer : <span class="keyword">public</span> <a class="code" href="classOGRLayer.html">OGRLayer</a></div>
<div class="line">{</div>
<div class="line">    <a class="code" href="classOGRFeatureDefn.html">OGRFeatureDefn</a>     *poFeatureDefn;</div>
<div class="line">    FILE               *fp;</div>
<div class="line">    <span class="keywordtype">int</span>                 nNextFID;</div>
<div class="line"></div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    OGRSPFLayer( <span class="keyword">const</span> <span class="keywordtype">char</span> *pszFilename );</div>
<div class="line">   ~OGRSPFLayer();</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">void</span>                <a class="code" href="classOGRLayer.html#aad0f2cd7f0587584b8f382c6a913583c">ResetReading</a>();</div>
<div class="line">    <a class="code" href="classOGRFeature.html">OGRFeature</a> *        <a class="code" href="classOGRLayer.html#a466c14ed1b3cca83abda52729d590dd2">GetNextFeature</a>();</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classOGRFeatureDefn.html">OGRFeatureDefn</a> *    <a class="code" href="classOGRLayer.html#a80473bcfd11341e70dd35bebe94026cf">GetLayerDefn</a>() { <span class="keywordflow">return</span> poFeatureDefn; }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span>                 <a class="code" href="classOGRLayer.html#aeedbda1a62f9b89b8e5f24332cf22286">TestCapability</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> * ) { <span class="keywordflow">return</span> FALSE; }</div>
<div class="line">};</div>
</div><!-- fragment --><p>The layer constructor is responsible for initialization. The most important initialization is setting up the <a class="el" href="classOGRFeatureDefn.html" title="Definition of a feature class or feature layer. ">OGRFeatureDefn</a> for the layer. This defines the list of fields and their types, the geometry type and the coordinate system for the layer. In the SPF format the set of fields is fixed - a single string field and we have no coordinate system info to set.</p>
<p>Pay particular attention to the reference counting of the <a class="el" href="classOGRFeatureDefn.html" title="Definition of a feature class or feature layer. ">OGRFeatureDefn</a>. As <a class="el" href="classOGRFeature.html" title="A simple feature, including geometry and attributes. ">OGRFeature</a>'s for this layer will also take a reference to this definition, it is important that we also establish a reference on behalf of the layer itself.</p>
<div class="fragment"><div class="line">OGRSPFLayer::OGRSPFLayer( <span class="keyword">const</span> <span class="keywordtype">char</span> *pszFilename )</div>
<div class="line">{</div>
<div class="line">    nNextFID = 0;</div>
<div class="line"></div>
<div class="line">    poFeatureDefn = <span class="keyword">new</span> <a class="code" href="classOGRFeatureDefn.html">OGRFeatureDefn</a>(<a class="code" href="cpl__conv_8h.html#a1c55dcd6abf2981f2275842277491ebc">CPLGetBasename</a>(pszFilename));</div>
<div class="line">    SetDescription(poFeatureDefn-&gt;GetName());</div>
<div class="line">    poFeatureDefn-&gt;Reference();</div>
<div class="line">    poFeatureDefn-&gt;SetGeomType(<a class="code" href="ogr__core_8h.html#a800236a0d460ef66e687b7b65610f12aa6f8377c5a4a9d36ae2384f4a5f45d77f">wkbPoint</a>);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classOGRFieldDefn.html">OGRFieldDefn</a> oFieldTemplate(<span class="stringliteral">&quot;Name&quot;</span>, <a class="code" href="ogr__core_8h.html#a787194bea637faf12d61643124a7c9fca862a7b8506c67c5390c2e0860c4edf45">OFTString</a>);</div>
<div class="line"></div>
<div class="line">    poFeatureDefn-&gt;AddFieldDefn(&amp;oFieldTemplate);</div>
<div class="line"></div>
<div class="line">    fp = <a class="code" href="cpl__vsi_8h.html#ae3cfa1605ce32e78fddb534bba7742f5">VSIFOpenL</a>(pszFilename, <span class="stringliteral">&quot;r&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>( fp == NULL )</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Note that the destructor uses Release() on the <a class="el" href="classOGRFeatureDefn.html" title="Definition of a feature class or feature layer. ">OGRFeatureDefn</a>. This will destroy the feature definition if the reference count drops to zero, but if the application is still holding onto a feature from this layer, then that feature will hold a reference to the feature definition and it will not be destroyed here (which is good!).</p>
<div class="fragment"><div class="line">OGRSPFLayer::~OGRSPFLayer()</div>
<div class="line">{</div>
<div class="line">    poFeatureDefn-&gt;Release();</div>
<div class="line">    <span class="keywordflow">if</span>( fp != NULL )</div>
<div class="line">        <a class="code" href="cpl__vsi_8h.html#ae7fe3eb9b2988c5a3c74889697f87e45">VSIFCloseL</a>(fp);</div>
<div class="line">}</div>
</div><!-- fragment --><p>The GetNextFeature() method is usually the work horse of <a class="el" href="classOGRLayer.html" title="This class represents a layer of simple features, with access methods. ">OGRLayer</a> implementations. It is responsible for reading the next feature according to the current spatial and attribute filters installed.</p>
<p>The while() loop is present to loop until we find a satisfactory feature. The first section of code is for parsing a single line of the SPF text file and establishing the x, y and name for the line.</p>
<div class="fragment"><div class="line"><a class="code" href="classOGRFeature.html">OGRFeature</a> *OGRSPFLayer::GetNextFeature()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Loop till we find a feature matching our requirements.</span></div>
<div class="line">    <span class="keywordflow">while</span>( <span class="keyword">true</span> )</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *pszLine = <a class="code" href="cpl__conv_8h.html#af049d0b413b82ac770d33cc76f525825">CPLReadLineL</a>(fp);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Are we at end of file (out of features)?</span></div>
<div class="line">        <span class="keywordflow">if</span>( pszLine == NULL )</div>
<div class="line">            <span class="keywordflow">return</span> NULL;</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> dfX = atof(pszLine);</div>
<div class="line"></div>
<div class="line">        pszLine = strstr(pszLine,<span class="stringliteral">&quot;|&quot;</span>);</div>
<div class="line">        <span class="keywordflow">if</span>( pszLine == NULL )</div>
<div class="line">            <span class="keywordflow">continue</span>; <span class="comment">// we should issue an error!</span></div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            pszLine++;</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">double</span> dfY = atof(pszLine);</div>
<div class="line"></div>
<div class="line">        pszLine = strstr(pszLine,<span class="stringliteral">&quot;|&quot;</span>);</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *pszName = NULL;</div>
<div class="line">        <span class="keywordflow">if</span>( pszLine == NULL )</div>
<div class="line">            <span class="keywordflow">continue</span>; <span class="comment">// we should issue an error!</span></div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            pszName = pszLine + 1;</div>
</div><!-- fragment --><p>The next section turns the x, y and name into a feature. Also note that we assign a linearly incremented feature id. In our case we started at zero for the first feature, though some drivers start at 1.</p>
<div class="fragment"><div class="line"><a class="code" href="classOGRFeature.html">OGRFeature</a> *poFeature = <span class="keyword">new</span> <a class="code" href="classOGRFeature.html">OGRFeature</a>(poFeatureDefn);</div>
<div class="line"></div>
<div class="line">poFeature-&gt;<a class="code" href="classOGRFeature.html#a40a4ddb33f09a5f340b9139be72e277d">SetGeometryDirectly</a>(<span class="keyword">new</span> <a class="code" href="classOGRPoint.html">OGRPoint</a>(dfX, dfY));</div>
<div class="line">poFeature-&gt;<a class="code" href="classOGRFeature.html#a4abbe118cc2f3e48bbac7f710b71b531">SetField</a>(0, pszName);</div>
<div class="line">poFeature-&gt;<a class="code" href="classOGRFeature.html#ad159156f6e544343f3f24081208a4b42">SetFID</a>(nNextFID++);</div>
</div><!-- fragment --><p>Next we check if the feature matches our current attribute or spatial filter if we have them. Methods on the <a class="el" href="classOGRLayer.html" title="This class represents a layer of simple features, with access methods. ">OGRLayer</a> base class support maintain filters in the <a class="el" href="classOGRLayer.html" title="This class represents a layer of simple features, with access methods. ">OGRLayer</a> member fields m_poFilterGeom (spatial filter) and m_poAttrQuery (attribute filter) so we can just use these values here if they are non-NULL. The following test is essentially "stock" and done the same in all formats. Some formats also do some spatial filtering ahead of time using a spatial index.</p>
<p>If the feature meets our criteria we return it. Otherwise we destroy it, and return to the top of the loop to fetch another to try.</p>
<div class="fragment"><div class="line">        <span class="keywordflow">if</span>( (m_poFilterGeom == NULL ||</div>
<div class="line">             FilterGeometry(poFeature-&gt;<a class="code" href="classOGRFeature.html#acc966ce8c10ae3ddf9f14c2736fdce9a">GetGeometryRef</a>())) &amp;&amp;</div>
<div class="line">            (m_poAttrQuery == NULL ||</div>
<div class="line">             m_poAttrQuery-&gt;Evaluate(poFeature)) )</div>
<div class="line">            <span class="keywordflow">return</span> poFeature;</div>
<div class="line"></div>
<div class="line">        <span class="keyword">delete</span> poFeature;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p>While in the middle of reading a feature set from a layer, or at any other time the application can call ResetReading() which is intended to restart reading at the beginning of the feature set. We implement this by seeking back to the beginning of the file, and resetting our feature id counter.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> OGRSPFLayer::ResetReading()</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="cpl__vsi_8h.html#ab32d81e8bf69e8e6e87f0aadf0a490c3">VSIFSeekL</a>(fp, 0, SEEK_SET);</div>
<div class="line">    nNextFID = 0;</div>
<div class="line">}</div>
</div><!-- fragment --><p>In this implementation we do not provide a custom implementation for the GetFeature() method. This means an attempt to read a particular feature by its feature id will result in many calls to GetNextFeature() until the desired feature is found. However, in a sequential text format like spf there is little else we could do anyway.</p>
<p>There! We have completed a simple read-only feature file format driver. </p>
</div></div><!-- contents -->
<hr>
Generated for GDAL by
<a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.8.8.
</body>
</html>
