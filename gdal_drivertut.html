<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>GDAL: GDAL Driver Implementation Tutorial</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">GDAL
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="usergroup0.html"><span>Download</span></a></li>
      <li><a href="https://github.com/OSGeo/gdal/issues/"><span>Issue&#160;Tracker</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">GDAL Driver Implementation Tutorial </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="gdal_drivertut_overall"></a>
Overall Approach</h1>
<p>In general new formats are added to GDAL by implementing format specific drivers as subclasses of <a class="el" href="classGDALDataset.html" title="A set of associated raster bands, usually from one file. ">GDALDataset</a>, and band accessors as subclasses of <a class="el" href="classGDALRasterBand.html" title="A single raster band (or channel). ">GDALRasterBand</a>. As well, a <a class="el" href="classGDALDriver.html" title="Format specific driver. ">GDALDriver</a> instance is created for the format, and registered with the <a class="el" href="classGDALDriverManager.html" title="Class for managing the registration of file format drivers. ">GDALDriverManager</a>, to ensure that the system <em>knows</em> about the format.</p>
<p>This tutorial will start with implementing a simple read-only driver (based on the JDEM driver), and then proceed to utilizing the RawRasterBand helper class, implementing creatable and updatable formats, and some esoteric issues.</p>
<p>It is strongly advised that the <a href="gdal_datamodel.html">GDAL Data Model </a> description be reviewed and understood before attempting to implement a GDAL driver.</p>
<h1><a class="anchor" id="gdal_drivertut_toc"></a>
Contents</h1>
<ol>
<li>
<a class="el" href="gdal_drivertut.html#gdal_drivertut_dataset">Implementing the Dataset</a> </li>
<li>
<a class="el" href="gdal_drivertut.html#gdal_drivertut_rasterband">Implementing the RasterBand</a> </li>
<li>
<a class="el" href="gdal_drivertut.html#gdal_drivertut_driver">The Driver</a> </li>
<li>
<a class="el" href="gdal_drivertut.html#gdal_drivertut_addingdriver">Adding Driver to GDAL Tree</a> </li>
<li>
<a class="el" href="gdal_drivertut.html#gdal_drivertut_georef">Adding Georeferencing</a> </li>
<li>
<a class="el" href="gdal_drivertut.html#gdal_drivertut_overviews">Overviews</a> </li>
<li>
<a class="el" href="gdal_drivertut.html#gdal_drivertut_creation">File Creation</a> </li>
<li>
<a class="el" href="gdal_drivertut.html#gdal_drivertut_raw">RawDataset/RawRasterBand Helper Classes</a> </li>
<li>
<a class="el" href="gdal_drivertut.html#gdal_drivertut_metadata">Metadata, and Other Exotic Extensions</a> </li>
</ol>
<h1><a class="anchor" id="gdal_drivertut_dataset"></a>
Implementing the Dataset</h1>
<p>We will start showing minimal implementation of a read-only driver for the Japanese DEM format (<a href="jdemdataset.cpp.html">jdemdataset.cpp</a>). First we declare a format specific dataset class, JDEMDataset in this case.</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>JDEMDataset : <span class="keyword">public</span> <a class="code" href="classGDALPamDataset.html">GDALPamDataset</a></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">friend</span> <span class="keyword">class </span>JDEMRasterBand;</div>
<div class="line"></div>
<div class="line">    FILE        *fp;</div>
<div class="line">    <a class="code" href="cpl__port_8h.html#ae7fbc84d3d1f7a40973be07382e28401">GByte</a>       abyHeader[1012];</div>
<div class="line"></div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">                ~JDEMDataset();</div>
<div class="line"></div>
<div class="line">    <span class="keyword">static</span> <a class="code" href="classGDALDataset.html">GDALDataset</a> *<a class="code" href="classGDALDataset.html#a5379df6aeeebe76a985365acaeab756d">Open</a>( <a class="code" href="classGDALOpenInfo.html">GDALOpenInfo</a> * );</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">int</span>          Identify( <a class="code" href="classGDALOpenInfo.html">GDALOpenInfo</a> * );</div>
<div class="line"></div>
<div class="line">    <a class="code" href="cpl__error_8h.html#a463ba7c7202a505416ff95b1aeefa2de">CPLErr</a>      <a class="code" href="classGDALPamDataset.html#ac080c8a42a6cddab42bc4fd21ac49bf6">GetGeoTransform</a>( <span class="keywordtype">double</span> * padfTransform );</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="classGDALPamDataset.html#a1a42a2a51d01b274e9871397317c577f">GetProjectionRef</a>();</div>
<div class="line">};</div>
</div><!-- fragment --><p>In general we provide capabilities for a driver, by overriding the various virtual methods on the <a class="el" href="classGDALDataset.html" title="A set of associated raster bands, usually from one file. ">GDALDataset</a> base class. However, the Open() method is special. This is not a virtual method on the base class, and we will need a freestanding function for this operation, so we declare it static. Implementing it as a method in the JDEMDataset class is convenient because we have privileged access to modify the contents of the database object.</p>
<p>The open method itself may look something like this:</p>
<div class="fragment"><div class="line"><a class="code" href="classGDALDataset.html">GDALDataset</a> *JDEMDataset::Open( <a class="code" href="classGDALOpenInfo.html">GDALOpenInfo</a> *poOpenInfo )</div>
<div class="line"></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Confirm that the header is compatible with a JDEM dataset.</span></div>
<div class="line">    <span class="keywordflow">if</span>( !Identify(poOpenInfo) )</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Confirm the requested access is supported.</span></div>
<div class="line">    <span class="keywordflow">if</span>( poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#a720dbd5edc6176843b2e73d21c9cf23c">eAccess</a> == <a class="code" href="gdal_8h.html#a045e3967c208993f70257bfd40c9f1d7a61c6081de474ef2a756982d3c53130a2">GA_Update</a> )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="cpl__error_8h.html#afda4d86428c1c533449ae6a69cdf430d">CPLError</a>(CE_Failure, <a class="code" href="cpl__error_8h.html#a3a532186d9f9e2699aee57aab0648b5e">CPLE_NotSupported</a>,</div>
<div class="line">                 <span class="stringliteral">&quot;The JDEM driver does not support update access to existing &quot;</span></div>
<div class="line">                 <span class="stringliteral">&quot;datasets.&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Check that the file pointer from GDALOpenInfo* is available</span></div>
<div class="line">    <span class="keywordflow">if</span>( poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#a90892bf145ec8347891e6eaa5c8cce4a">fpL</a> == NULL )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create a corresponding GDALDataset.</span></div>
<div class="line">    JDEMDataset *poDS = <span class="keyword">new</span> JDEMDataset();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Borrow the file pointer from GDALOpenInfo*.</span></div>
<div class="line">    poDS-&gt;fp = poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#a90892bf145ec8347891e6eaa5c8cce4a">fpL</a>;</div>
<div class="line">    poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#a90892bf145ec8347891e6eaa5c8cce4a">fpL</a> = NULL;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Read the header.</span></div>
<div class="line">    <a class="code" href="cpl__vsi_8h.html#a3e64279a239eef70703efc09f43585e9">VSIFReadL</a>(poDS-&gt;abyHeader, 1, 1012, poDS-&gt;fp);</div>
<div class="line"></div>
<div class="line">    poDS-&gt;nRasterXSize =</div>
<div class="line">        JDEMGetField(reinterpret_cast&lt;char *&gt;(poDS-&gt;abyHeader) + 23, 3);</div>
<div class="line">    poDS-&gt;nRasterYSize =</div>
<div class="line">        JDEMGetField(reinterpret_cast&lt;char *&gt;(poDS-&gt;abyHeader) + 26, 3);</div>
<div class="line">    <span class="keywordflow">if</span>( poDS-&gt;nRasterXSize &lt;= 0 || poDS-&gt;nRasterYSize &lt;= 0 )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="cpl__error_8h.html#afda4d86428c1c533449ae6a69cdf430d">CPLError</a>(CE_Failure, <a class="code" href="cpl__error_8h.html#a7151d0699caa1372a8566562390ff113">CPLE_AppDefined</a>,</div>
<div class="line">                 <span class="stringliteral">&quot;Invalid dimensions : %d x %d&quot;</span>,</div>
<div class="line">                 poDS-&gt;nRasterXSize, poDS-&gt;nRasterYSize);</div>
<div class="line">        <span class="keyword">delete</span> poDS;</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create band information objects.</span></div>
<div class="line">    poDS-&gt;SetBand(1, <span class="keyword">new</span> JDEMRasterBand(poDS, 1));</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Initialize any PAM information.</span></div>
<div class="line">    poDS-&gt;SetDescription(poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#ac4853cfc89944973b4811a7422d20837">pszFilename</a>);</div>
<div class="line">    poDS-&gt;TryLoadXML();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Initialize default overviews.</span></div>
<div class="line">    poDS-&gt;oOvManager.Initialize(poDS, poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#ac4853cfc89944973b4811a7422d20837">pszFilename</a>);</div>
<div class="line">    <span class="keywordflow">return</span> poDS;</div>
<div class="line">}</div>
<div class="line">\code</div>
<div class="line"></div>
<div class="line">The first step in any database Open <span class="keyword">function</span> is to verify that the file</div>
<div class="line">being passed is in fact of the type <span class="keyword">this</span> driver is <span class="keywordflow">for</span>.  It is important</div>
<div class="line">to realize that each driver<span class="stringliteral">&#39;s Open function is called in turn till one</span></div>
<div class="line"><span class="stringliteral">succeeds.  Drivers must quietly return NULL if the passed file is not of</span></div>
<div class="line"><span class="stringliteral">their format.  They should only produce an error if the file does appear to</span></div>
<div class="line"><span class="stringliteral">be of their supported format, but is for some reason unsupported or corrupt.</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">The information on the file to be opened is passed in contained in a</span></div>
<div class="line"><span class="stringliteral">GDALOpenInfo object.  The GDALOpenInfo includes the following public</span></div>
<div class="line"><span class="stringliteral">data members:</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">\code</span></div>
<div class="line"><span class="stringliteral">    char        *pszFilename;</span></div>
<div class="line"><span class="stringliteral">    char**      papszOpenOptions;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    GDALAccess  eAccess;  // GA_ReadOnly or GA_Update</span></div>
<div class="line"><span class="stringliteral">    int         nOpenFlags;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    int         bStatOK;</span></div>
<div class="line"><span class="stringliteral">    int         bIsDirectory;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    VSILFILE   *fpL;</span></div>
<div class="line"><span class="stringliteral"></span></div>
<div class="line"><span class="stringliteral">    int         nHeaderBytes;</span></div>
<div class="line"><span class="stringliteral">    GByte       *pabyHeader;</span></div>
</div><!-- fragment --><p>The driver can inspect these to establish if the file is supported. If the pszFilename refers to an object in the file system, the <b>bStatOK</b> flag will be set to TRUE. As well, if the file was successfully opened, the first kilobyte or so is read in, and put in <b>pabyHeader</b>, with the exact size in <b>nHeaderBytes</b>.</p>
<p>In this typical testing example it is verified that the file was successfully opened, that we have at least enough header information to perform our test, and that various parts of the header are as expected for this format. In this case, there are no <em>magic</em> numbers for JDEM format so we check various date fields to ensure they have reasonable century values. If the test fails, we quietly return NULL indicating this file isn't of our supported format.</p>
<p>The identification is in fact delegated to a Identify() static function :</p>
<div class="fragment"><div class="line"><span class="comment">/************************************************************************/</span></div>
<div class="line"><span class="comment">/*                              Identify()                              */</span></div>
<div class="line"><span class="comment">/************************************************************************/</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> JDEMDataset::Identify( <a class="code" href="classGDALOpenInfo.html">GDALOpenInfo</a> * poOpenInfo )</div>
<div class="line"></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Confirm that the header has what appears to be dates in the</span></div>
<div class="line">    <span class="comment">// expected locations.  Sadly this is a relatively weak test.</span></div>
<div class="line">    <span class="keywordflow">if</span>( poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#af62c6ba9270758c340908885ebcf4c4d">nHeaderBytes</a> &lt; 50 )</div>
<div class="line">        <span class="keywordflow">return</span> FALSE;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Check if century values seem reasonable.</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *psHeader = <span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">char</span> *<span class="keyword">&gt;</span>(poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#a2193ea49d916003baa90e75426309e10">pabyHeader</a>);</div>
<div class="line">    <span class="keywordflow">if</span>( (!<a class="code" href="cpl__port_8h.html#a96b4fe28af61448f5ae7cb219601eee3">EQUALN</a>(psHeader + 11, <span class="stringliteral">&quot;19&quot;</span>, 2) &amp;&amp;</div>
<div class="line">         !<a class="code" href="cpl__port_8h.html#a96b4fe28af61448f5ae7cb219601eee3">EQUALN</a>(psHeader + 11, <span class="stringliteral">&quot;20&quot;</span>, 2)) ||</div>
<div class="line">        (!<a class="code" href="cpl__port_8h.html#a96b4fe28af61448f5ae7cb219601eee3">EQUALN</a>(psHeader + 15, <span class="stringliteral">&quot;19&quot;</span>, 2) &amp;&amp;</div>
<div class="line">         !<a class="code" href="cpl__port_8h.html#a96b4fe28af61448f5ae7cb219601eee3">EQUALN</a>(psHeader + 15, <span class="stringliteral">&quot;20&quot;</span>, 2)) ||</div>
<div class="line">        (!<a class="code" href="cpl__port_8h.html#a96b4fe28af61448f5ae7cb219601eee3">EQUALN</a>(psHeader + 19, <span class="stringliteral">&quot;19&quot;</span>, 2) &amp;&amp;</div>
<div class="line">         !<a class="code" href="cpl__port_8h.html#a96b4fe28af61448f5ae7cb219601eee3">EQUALN</a>(psHeader + 19, <span class="stringliteral">&quot;20&quot;</span>, 2)) )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">return</span> FALSE;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> TRUE;</div>
<div class="line">}</div>
<div class="line">\code</div>
<div class="line"></div>
<div class="line">It is important to make the &lt;i&gt;is <span class="keyword">this</span> my format&lt;/i&gt; test as stringent as</div>
<div class="line">possible.  In <span class="keyword">this</span> particular <span class="keywordflow">case</span> the test is weak, and a file that happened</div>
<div class="line">to have 19s or 20s at a few locations could be erroneously recognized as</div>
<div class="line">JDEM format, causing it to not be handled properly.</div>
<div class="line"></div>
<div class="line">Once we are satisfied that the file is of our format, we can <span class="keywordflow">do</span> any other</div>
<div class="line">tests that are necessary to validate the file is usable, and in particular</div>
<div class="line">that we can provide the level of access desired.  Since the JDEM driver does</div>
<div class="line">not provide update support, error out in that <span class="keywordflow">case</span>.</div>
<div class="line"></div>
<div class="line">\code</div>
<div class="line">    <span class="keywordflow">if</span>( poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#a720dbd5edc6176843b2e73d21c9cf23c">eAccess</a> == <a class="code" href="gdal_8h.html#a045e3967c208993f70257bfd40c9f1d7a61c6081de474ef2a756982d3c53130a2">GA_Update</a> )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="cpl__error_8h.html#afda4d86428c1c533449ae6a69cdf430d">CPLError</a>(CE_Failure, <a class="code" href="cpl__error_8h.html#a3a532186d9f9e2699aee57aab0648b5e">CPLE_NotSupported</a>,</div>
<div class="line">                 <span class="stringliteral">&quot;The JDEM driver does not support update access to existing &quot;</span></div>
<div class="line">                 <span class="stringliteral">&quot;datasets.&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
</div><!-- fragment --><p>Next we need to create an instance of the database class in which we will set various information of interest.</p>
<div class="fragment"><div class="line"><span class="comment">// Check that the file pointer from GDALOpenInfo* is available.</span></div>
<div class="line"><span class="keywordflow">if</span>( poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#a90892bf145ec8347891e6eaa5c8cce4a">fpL</a> == NULL )</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">JDEMDataset *poDS = <span class="keyword">new</span> JDEMDataset();</div>
<div class="line"></div>
<div class="line"><span class="comment">// Borrow the file pointer from GDALOpenInfo*.</span></div>
<div class="line">poDS-&gt;fp = poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#a90892bf145ec8347891e6eaa5c8cce4a">fpL</a>;</div>
<div class="line">poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#a90892bf145ec8347891e6eaa5c8cce4a">fpL</a> = NULL;</div>
</div><!-- fragment --><p>At this point we "borrow" the file handle that was held by GDALOpenInfo*. This file pointer uses the VSI*L GDAL API to access files on disk. This virtualized POSIX-style API allows some special capabilities like supporting large files, in-memory files and zipped files.</p>
<p>Next the X and Y size are extracted from the header. The nRasterXSize and nRasterYSize are data fields inherited from the <a class="el" href="classGDALDataset.html" title="A set of associated raster bands, usually from one file. ">GDALDataset</a> base class, and must be set by the Open() method.</p>
<div class="fragment"><div class="line"><a class="code" href="cpl__vsi_8h.html#a3e64279a239eef70703efc09f43585e9">VSIFReadL</a>(poDS-&gt;abyHeader, 1, 1012, poDS-&gt;fp);</div>
<div class="line"></div>
<div class="line">poDS-&gt;nRasterXSize =</div>
<div class="line">    JDEMGetField(reinterpret_cast&lt;char *&gt;(poDS-&gt;abyHeader) + 23, 3);</div>
<div class="line">poDS-&gt;nRasterYSize =</div>
<div class="line">    JDEMGetField(reinterpret_cast&lt;char *&gt;(poDS-&gt;abyHeader) + 26, 3);</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span>  (poDS-&gt;nRasterXSize &lt;= 0 || poDS-&gt;nRasterYSize &lt;= 0 )</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="cpl__error_8h.html#afda4d86428c1c533449ae6a69cdf430d">CPLError</a>(CE_Failure, <a class="code" href="cpl__error_8h.html#a7151d0699caa1372a8566562390ff113">CPLE_AppDefined</a>,</div>
<div class="line">             <span class="stringliteral">&quot;Invalid dimensions : %d x %d&quot;</span>,</div>
<div class="line">             poDS-&gt;nRasterXSize, poDS-&gt;nRasterYSize);</div>
<div class="line">    <span class="keyword">delete</span> poDS;</div>
<div class="line">    <span class="keywordflow">return</span> NULL;</div>
<div class="line">}</div>
</div><!-- fragment --><p>All the bands related to this dataset must be created and attached using the SetBand() method. We will explore the JDEMRasterBand() class shortly.</p>
<div class="fragment"><div class="line"><span class="comment">// Create band information objects.</span></div>
<div class="line">poDS-&gt;SetBand(1, <span class="keyword">new</span> JDEMRasterBand(poDS, 1));</div>
</div><!-- fragment --><p>Finally we assign a name to the dataset object, and call the <a class="el" href="classGDALPamDataset.html" title="PAM dataset. ">GDALPamDataset</a> TryLoadXML() method which can initialize auxiliary information from an .aux.xml file if available. For more details on these services review the <a class="el" href="classGDALPamDataset.html" title="PAM dataset. ">GDALPamDataset</a> and related classes.</p>
<div class="fragment"><div class="line">    <span class="comment">// Initialize any PAM information.</span></div>
<div class="line">    poDS-&gt;SetDescription( poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#ac4853cfc89944973b4811a7422d20837">pszFilename</a> );</div>
<div class="line">    poDS-&gt;TryLoadXML();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> poDS;</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="gdal_drivertut_rasterband"></a>
Implementing the RasterBand</h1>
<p>Similar to the customized JDEMDataset class subclassed from <a class="el" href="classGDALDataset.html" title="A set of associated raster bands, usually from one file. ">GDALDataset</a>, we also need to declare and implement a customized JDEMRasterBand derived from <a class="el" href="classGDALRasterBand.html" title="A single raster band (or channel). ">GDALRasterBand</a> for access to the band(s) of the JDEM file. For JDEMRasterBand the declaration looks like this:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>JDEMRasterBand : <span class="keyword">public</span> <a class="code" href="classGDALPamRasterBand.html">GDALPamRasterBand</a></div>
<div class="line">{</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line">    JDEMRasterBand( JDEMDataset *, <span class="keywordtype">int</span> );</div>
<div class="line">    <span class="keyword">virtual</span> <a class="code" href="cpl__error_8h.html#a463ba7c7202a505416ff95b1aeefa2de">CPLErr</a> <a class="code" href="classGDALRasterBand.html#aa48009722cbd31558f70233c62d94602">IReadBlock</a>( <span class="keywordtype">int</span>, <span class="keywordtype">int</span>, <span class="keywordtype">void</span> * );</div>
<div class="line">};</div>
</div><!-- fragment --><p>The constructor may have any signature, and is only called from the Open() method. Other virtual methods, such as IReadBlock() must be exactly matched to the method signature in <a class="el" href="gdal__priv_8h.html" title="C++ GDAL entry points. ">gdal_priv.h</a>.</p>
<p>The constructor implementation looks like this:</p>
<div class="fragment"><div class="line">JDEMRasterBand::JDEMRasterBand( JDEMDataset *poDSIn, <span class="keywordtype">int</span> nBandIn )</div>
<div class="line"></div>
<div class="line">{</div>
<div class="line">    poDS = poDSIn;</div>
<div class="line">    nBand = nBandIn;</div>
<div class="line"></div>
<div class="line">    eDataType = <a class="code" href="gdal_8h.html#a22e22ce0a55036a96f652765793fb7a4af5cbd2f96abffd9ac061fc0dced5cbba">GDT_Float32</a>;</div>
<div class="line"></div>
<div class="line">    nBlockXSize = poDS-&gt;GetRasterXSize();</div>
<div class="line">    nBlockYSize = 1;</div>
<div class="line">}</div>
</div><!-- fragment --><p>The following data members are inherited from <a class="el" href="classGDALRasterBand.html" title="A single raster band (or channel). ">GDALRasterBand</a>, and should generally be set in the band constructor.</p>
<ul>
<li>
<b>poDS</b>: Pointer to the parent <a class="el" href="classGDALDataset.html" title="A set of associated raster bands, usually from one file. ">GDALDataset</a>. </li>
<li>
<b>nBand</b>: The band number within the dataset. </li>
<li>
<b>eDataType</b>: The data type of pixels in this band. </li>
<li>
<b>nBlockXSize</b>: The width of one block in this band. </li>
<li>
<b>nBlockYSize</b>: The height of one block in this band. </li>
</ul>
<p>The full set of possible GDALDataType values are declared in <a class="el" href="gdal_8h.html" title="Public (C callable) GDAL entry points. ">gdal.h</a>, and include GDT_Byte, GDT_UInt16, GDT_Int16, and GDT_Float32. The block size is used to establish a <em>natural</em> or efficient block size to access the data with. For tiled datasets this will be the size of a tile, while for most other datasets it will be one scanline, as in this case.</p>
<p>Next we see the implementation of the code that actually reads the image data, IReadBlock().</p>
<div class="fragment"><div class="line"><a class="code" href="cpl__error_8h.html#a463ba7c7202a505416ff95b1aeefa2de">CPLErr</a> JDEMRasterBand::IReadBlock( <span class="keywordtype">int</span> nBlockXOff, <span class="keywordtype">int</span> nBlockYOff,</div>
<div class="line">                                  <span class="keywordtype">void</span> * pImage )</div>
<div class="line"></div>
<div class="line">{</div>
<div class="line">    JDEMDataset *poGDS = <span class="keyword">static_cast&lt;</span>JDEMDataset *<span class="keyword">&gt;</span>(poDS);</div>
<div class="line">    <span class="keywordtype">int</span> nRecordSize = nBlockXSize * 5 + 9 + 2;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="cpl__vsi_8h.html#ab32d81e8bf69e8e6e87f0aadf0a490c3">VSIFSeekL</a>(poGDS-&gt;fp, 1011 + nRecordSize*nBlockYOff, SEEK_SET);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">char</span> *pszRecord = <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span> *<span class="keyword">&gt;</span>(<a class="code" href="cpl__conv_8h.html#a9a806de98fbddb1337efdb18651aa0f7">CPLMalloc</a>(nRecordSize));</div>
<div class="line">    <a class="code" href="cpl__vsi_8h.html#a3e64279a239eef70703efc09f43585e9">VSIFReadL</a>(pszRecord, 1, nRecordSize, poGDS-&gt;fp);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( !<a class="code" href="cpl__port_8h.html#a96b4fe28af61448f5ae7cb219601eee3">EQUALN</a>(reinterpret_cast&lt;char *&gt;(poGDS-&gt;abyHeader), pszRecord, 6) )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="cpl__conv_8h.html#a21b7f312da39ddb0a12bdde06b153b48">CPLFree</a>(pszRecord);</div>
<div class="line"></div>
<div class="line">        <a class="code" href="cpl__error_8h.html#afda4d86428c1c533449ae6a69cdf430d">CPLError</a>(CE_Failure, <a class="code" href="cpl__error_8h.html#a7151d0699caa1372a8566562390ff113">CPLE_AppDefined</a>,</div>
<div class="line">                 <span class="stringliteral">&quot;JDEM Scanline corrupt.  Perhaps file was not transferred &quot;</span></div>
<div class="line">                 <span class="stringliteral">&quot;in binary mode?&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> CE_Failure;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( JDEMGetField(pszRecord + 6, 3) != nBlockYOff + 1 )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="cpl__conv_8h.html#a21b7f312da39ddb0a12bdde06b153b48">CPLFree</a>(pszRecord);</div>
<div class="line"></div>
<div class="line">        <a class="code" href="cpl__error_8h.html#afda4d86428c1c533449ae6a69cdf430d">CPLError</a>(CE_Failure, <a class="code" href="cpl__error_8h.html#a7151d0699caa1372a8566562390ff113">CPLE_AppDefined</a>,</div>
<div class="line">                 <span class="stringliteral">&quot;JDEM scanline out of order, JDEM driver does not &quot;</span></div>
<div class="line">                 <span class="stringliteral">&quot;currently support partial datasets.&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> CE_Failure;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; nBlockXSize; i++ )</div>
<div class="line">        ((<span class="keywordtype">float</span> *) pImage)[i] = JDEMGetField(pszRecord + 9 + 5 * i, 5) * 0.1;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> CE_None;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Key items to note are:</p>
<ul>
<li>
<p class="startli">It is typical to cast the GDALRasterBand::poDS member to the derived type of the owning dataset. If your RasterBand class will need privileged access to the owning dataset object, ensure it is declared as a friend (omitted above for brevity).</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">If an error occurs, report it with <a class="el" href="cpl__error_8h.html#afda4d86428c1c533449ae6a69cdf430d" title="Report an error. ">CPLError()</a>, and return CE_Failure. Otherwise return CE_None.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">The pImage buffer should be filled with one block of data. The block is the size declared in nBlockXSize and nBlockYSize for the raster band. The type of the data within pImage should match the type declared in eDataType in the raster band object.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">The nBlockXOff and nBlockYOff are block offsets, so with 128x128 tiled datasets values of 1 and 1 would indicate the block going from (128,128) to (255,255) should be loaded.</p>
<p class="endli"></p>
</li>
</ul>
<h1><a class="anchor" id="gdal_drivertut_driver"></a>
The Driver</h1>
<p>While the JDEMDataset and JDEMRasterBand are now ready to use to read image data, it still isn't clear how the GDAL system knows about the new driver. This is accomplished via the <a class="el" href="classGDALDriverManager.html" title="Class for managing the registration of file format drivers. ">GDALDriverManager</a>. To register our format we implement a registration function. The declaration goes in <a class="el" href="gdal__frmts_8h_source.html">gcore/gdal_frmts.h</a>:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> CPL_DLL GDALRegister_JDEM(<span class="keywordtype">void</span>);</div>
</div><!-- fragment --><p>The definition in the driver file is:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> GDALRegister_JDEM()</div>
<div class="line"></div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span>( !<a class="code" href="gdal_8h.html#a10a0edfd51ed00f2460d4e8cfccbcc02">GDAL_CHECK_VERSION</a>(<span class="stringliteral">&quot;JDEM&quot;</span>) )</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( <a class="code" href="gdal_8h.html#ae8ae868eef1e4773283d137b0a1adfc4">GDALGetDriverByName</a>(<span class="stringliteral">&quot;JDEM&quot;</span>) != NULL )</div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="classGDALDriver.html">GDALDriver</a> *poDriver = <span class="keyword">new</span> <a class="code" href="classGDALDriver.html">GDALDriver</a>();</div>
<div class="line"></div>
<div class="line">    poDriver-&gt;<a class="code" href="classGDALMajorObject.html#af334bc8d152f130a55783ea36938735b">SetDescription</a>(<span class="stringliteral">&quot;JDEM&quot;</span>);</div>
<div class="line">    poDriver-&gt;<a class="code" href="classGDALDriver.html#a65130ea5fe7ea188b9c666080ea4ad30">SetMetadataItem</a>(<a class="code" href="gdal_8h.html#a25e3a5b5d4d7bea0602f98b9e2ea050c">GDAL_DCAP_RASTER</a>, <span class="stringliteral">&quot;YES&quot;</span>);</div>
<div class="line">    poDriver-&gt;<a class="code" href="classGDALDriver.html#a65130ea5fe7ea188b9c666080ea4ad30">SetMetadataItem</a>(<a class="code" href="gdal_8h.html#a10963a08bd12bf29b36d8a23fb45471f">GDAL_DMD_LONGNAME</a>,</div>
<div class="line">                              <span class="stringliteral">&quot;Japanese DEM (.mem)&quot;</span>);</div>
<div class="line">    poDriver-&gt;<a class="code" href="classGDALDriver.html#a65130ea5fe7ea188b9c666080ea4ad30">SetMetadataItem</a>(<a class="code" href="gdal_8h.html#a85442e30b5313c88213ba87bf1b1ef05">GDAL_DMD_HELPTOPIC</a>,</div>
<div class="line">                              <span class="stringliteral">&quot;frmt_various.html#JDEM&quot;</span>);</div>
<div class="line">    poDriver-&gt;<a class="code" href="classGDALDriver.html#a65130ea5fe7ea188b9c666080ea4ad30">SetMetadataItem</a>(<a class="code" href="gdal_8h.html#aebd79c9d69709cc61c0329fa2298fe18">GDAL_DMD_EXTENSION</a>, <span class="stringliteral">&quot;mem&quot;</span>);</div>
<div class="line">    poDriver-&gt;<a class="code" href="classGDALDriver.html#a65130ea5fe7ea188b9c666080ea4ad30">SetMetadataItem</a>(<a class="code" href="gdal_8h.html#ad1f10e72385fed566d178dc3f0067fb8">GDAL_DCAP_VIRTUALIO</a>, <span class="stringliteral">&quot;YES&quot;</span>);</div>
<div class="line"></div>
<div class="line">    poDriver-&gt;pfnOpen = JDEMDataset::Open;</div>
<div class="line">    poDriver-&gt;pfnIdentify = JDEMDataset::Identify;</div>
<div class="line"></div>
<div class="line">    <a class="code" href="gdal__priv_8h.html#a4fb74d15f12b1ecd77bd8e5c48086590">GetGDALDriverManager</a>()-&gt;<a class="code" href="classGDALDriverManager.html#aa33cc86affa255ac37b463c129fbe49f">RegisterDriver</a>(poDriver);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Note the use of GDAL_CHECK_VERSION macro (starting with GDAL 1.5.0). This is an optional macro for drivers inside GDAL tree that don't depend on external libraries, but that can be very useful if you compile your driver as a plugin (that is to say, an out-of-tree driver). As the GDAL C++ ABI may, and will, change between GDAL releases (for example from GDAL 1.5.0 to 1.6.0), it may be necessary to recompile your driver against the header files of the GDAL version with which you want to make it work. The GDAL_CHECK_VERSION macro will check that the GDAL version with which the driver was compiled and the version against which it is running are compatible.</p>
<p>The registration function will create an instance of a <a class="el" href="classGDALDriver.html" title="Format specific driver. ">GDALDriver</a> object when first called, and register it with the <a class="el" href="classGDALDriverManager.html" title="Class for managing the registration of file format drivers. ">GDALDriverManager</a>. The following fields can be set in the driver before registering it with the <a class="el" href="classGDALDriverManager.html" title="Class for managing the registration of file format drivers. ">GDALDriverManager()</a>.</p>
<ul>
<li>
<p class="startli">The description is the short name for the format. This is a unique name for this format, often used to identity the driver in scripts and command line programs. Normally 3-5 characters in length, and matching the prefix of the format classes. (mandatory)</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">GDAL_DCAP_RASTER: set to YES to indicate that this driver handles raster data. (mandatory)</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">GDAL_DMD_LONGNAME: A longer descriptive name for the file format, but still no longer than 50-60 characters. (mandatory)</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">GDAL_DMD_HELPTOPIC: The name of a help topic to display for this driver, if any. In this case JDEM format is contained within the various format web page held in gdal/html. (optional)</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">GDAL_DMD_EXTENSION: The extension used for files of this type. If more than one pick the primary extension, or none at all. (optional)</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">GDAL_DMD_MIMETYPE: The standard mime type for this file format, such as "image/png". (optional)</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">GDAL_DMD_CREATIONOPTIONLIST: There is evolving work on mechanisms to describe creation options. See the geotiff driver for an example of this. (optional)</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">GDAL_DMD_CREATIONDATATYPES: A list of space separated data types supported by this create when creating new datasets. If a Create() method exists, these will be will supported. If a CreateCopy() method exists, this will be a list of types that can be losslessly exported but it may include weaker data types than the type eventually written. For instance, a format with a CreateCopy() method, and that always writes Float32 might also list Byte, Int16, and UInt16 since they can losslessly translated to Float32. An example value might be "Byte Int16 UInt16". (required - if creation supported)</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">GDAL_DCAP_VIRTUALIO: set to YES to indicate that this driver can deal with files opened with the VSI*L GDAL API. Otherwise this metadata item should not be defined. (optional)</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">pfnOpen: The function to call to try opening files of this format. (optional)</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">pfnIdentify: The function to call to try identifying files of this format. A driver should return 1 if it recognizes the file as being of its format, 0 if it recognizes the file as being NOT of its format, or -1 if it cannot reach to a firm conclusion by just examining the header bytes. (optional)</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">pfnCreate: The function to call to create new updatable datasets of this format. (optional)</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">pfnCreateCopy: The function to call to create a new dataset of this format copied from another source, but not necessary updatable. (optional)</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">pfnDelete: The function to call to delete a dataset of this format. (optional)</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">pfnUnloadDriver: A function called only when the driver is destroyed. Could be used to cleanup data at the driver level. Rarely used. (optional)</p>
<p class="endli"></p>
</li>
</ul>
<h1><a class="anchor" id="gdal_drivertut_addingdriver"></a>
Adding Driver to GDAL Tree</h1>
<p>Note that the GDALRegister_JDEM() method must be called by the higher level program in order to have access to the JDEM driver. Normal practice when writing new drivers is to:</p>
<ol>
<li>
<p class="startli">Add a driver directory under gdal/frmts, with the directory name the same as the short name.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Add a GNUmakefile and makefile.vc in that directory modeled on those from other similar directories (i.e. the jdem directory).</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Add the module with the dataset, and rasterband implementation. Generally this is called &lt;short_name&gt;dataset.cpp, with all the GDAL specific code in one file, though that is not required.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Add the registration entry point declaration (i.e. GDALRegister_JDEM()) to <a class="el" href="gdal__frmts_8h_source.html">gdal/gcore/gdal_frmts.h</a>.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Add a call to the registration function to frmts/gdalallregister.cpp, protected by an appropriate #ifdef.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Add the format short name to the GDAL_FORMATS macro in GDALmake.opt.in (and to GDALmake.opt).</p>
<p class="endli"></p>
</li>
<li>
Add a format specific item to the EXTRAFLAGS macro in frmts/makefile.vc. </li>
</ol>
<p>Once this is all done, it should be possible to rebuild GDAL, and have the new format available in all the utilities. The gdalinfo utility can be used to test that opening and reporting on the format is working, and the gdal_translate utility can be used to test image reading.</p>
<h1><a class="anchor" id="gdal_drivertut_georef"></a>
Adding Georeferencing</h1>
<p>Now we will take the example a step forward, adding georeferencing support. We add the following two virtual method overrides to JDEMDataset, taking care to exactly match the signature of the method on the GDALRasterDataset base class.</p>
<div class="fragment"><div class="line"><a class="code" href="cpl__error_8h.html#a463ba7c7202a505416ff95b1aeefa2de">CPLErr</a>      GetGeoTransform( <span class="keywordtype">double</span> * padfTransform );</div>
<div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *GetProjectionRef();</div>
</div><!-- fragment --><p>The implementation of GetGeoTransform() just copies the usual geotransform matrix into the supplied buffer. Note that GetGeoTransform() may be called a lot, so it isn't generally wise to do a lot of computation in it. In many cases the Open() will collect the geotransform, and this method will just copy it over. Also note that the geotransform return is based on an anchor point at the top left corner of the top left pixel, not the center of pixel approach used in some packages.</p>
<div class="fragment"><div class="line"><a class="code" href="cpl__error_8h.html#a463ba7c7202a505416ff95b1aeefa2de">CPLErr</a> JDEMDataset::GetGeoTransform( <span class="keywordtype">double</span> * padfTransform )</div>
<div class="line"></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span> *psHeader = <span class="keyword">reinterpret_cast&lt;</span><span class="keywordtype">char</span> *<span class="keyword">&gt;</span>(abyHeader);</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> dfLLLat = JDEMGetAngle(psHeader + 29);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> dfLLLong = JDEMGetAngle(psHeader + 36);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> dfURLat = JDEMGetAngle(psHeader + 43);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">double</span> dfURLong = JDEMGetAngle(psHeader + 50);</div>
<div class="line"></div>
<div class="line">    padfTransform[0] = dfLLLong;</div>
<div class="line">    padfTransform[3] = dfURLat;</div>
<div class="line">    padfTransform[1] = (dfURLong - dfLLLong) / GetRasterXSize();</div>
<div class="line">    padfTransform[2] = 0.0;</div>
<div class="line"></div>
<div class="line">    padfTransform[4] = 0.0;</div>
<div class="line">    padfTransform[5] = -1 * (dfURLat - dfLLLat) / GetRasterYSize();</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> CE_None;</div>
<div class="line">}</div>
</div><!-- fragment --><p>The GetProjectionRef() method returns a pointer to an internal string containing a coordinate system definition in OGC WKT format. In this case the coordinate system is fixed for all files of this format, but in more complex cases a definition may need to be composed on the fly, in which case it may be helpful to use the <a class="el" href="classOGRSpatialReference.html" title="This class represents an OpenGIS Spatial Reference System, and contains methods for converting betwee...">OGRSpatialReference</a> class to help build the definition.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *JDEMDataset::GetProjectionRef()</div>
<div class="line"></div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span></div>
<div class="line">        <span class="stringliteral">&quot;GEOGCS[\&quot;Tokyo\&quot;,DATUM[\&quot;Tokyo\&quot;,SPHEROID[\&quot;Bessel 1841\&quot;,&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;6377397.155,299.1528128,AUTHORITY[\&quot;EPSG\&quot;,7004]],TOWGS84[-148,&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;507,685,0,0,0,0],AUTHORITY[\&quot;EPSG\&quot;,6301]],PRIMEM[\&quot;Greenwich\&quot;,&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;0,AUTHORITY[\&quot;EPSG\&quot;,8901]],UNIT[\&quot;DMSH\&quot;,0.0174532925199433,&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;AUTHORITY[\&quot;EPSG\&quot;,9108]],AXIS[\&quot;Lat\&quot;,NORTH],AXIS[\&quot;Long\&quot;,EAST],&quot;</span></div>
<div class="line">        <span class="stringliteral">&quot;AUTHORITY[\&quot;EPSG\&quot;,4301]]&quot;</span>;</div>
<div class="line">}</div>
</div><!-- fragment --><p>This completes explanation of the features of the JDEM driver. The full source for <a href="jdemdataset.cpp.html">jdemdataset.cpp</a> can be reviewed as needed.</p>
<h1><a class="anchor" id="gdal_drivertut_overviews"></a>
Overviews</h1>
<p>GDAL allows file formats to make pre-built overviews available to applications via the <a class="el" href="classGDALRasterBand.html#a2ab58ccaef2a64ad938cd69973c6ace1" title="Fetch overview raster band object. ">GDALRasterBand::GetOverview()</a> and related methods. However, implementing this is pretty involved, and goes beyond the scope of this document for now. The GeoTIFF driver (gdal/frmts/gtiff/geotiff.cpp) and related source can be reviewed for an example of a file format implementing overview reporting and creation support.</p>
<p>Formats can also report that they have arbitrary overviews, by overriding the HasArbitraryOverviews() method on the <a class="el" href="classGDALRasterBand.html" title="A single raster band (or channel). ">GDALRasterBand</a>, returning TRUE. In this case the raster band object is expected to override the RasterIO() method itself, to implement efficient access to imagery with resampling. This is also involved, and there are a lot of requirements for correct implementation of the RasterIO() method. An example of this can be found in the OGDI and ECW formats.</p>
<p>However, by far the most common approach to implementing overviews is to use the default support in GDAL for external overviews stored in TIFF files with the same name as the dataset, but the extension .ovr appended. In order to enable reading and creation of this style of overviews it is necessary for the <a class="el" href="classGDALDataset.html" title="A set of associated raster bands, usually from one file. ">GDALDataset</a> to initialize the oOvManager object within itself. This is typically accomplished with a call like the following near the end of the Open() method (after the PAM TryLoadXML()).</p>
<div class="fragment"><div class="line">poDS-&gt;oOvManager.Initialize(poDS, poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#ac4853cfc89944973b4811a7422d20837">pszFilename</a>);</div>
</div><!-- fragment --><p>This will enable default implementations for reading and creating overviews for the format. It is advised that this be enabled for all simple file system based formats unless there is a custom overview mechanism to be tied into.</p>
<h1><a class="anchor" id="gdal_drivertut_creation"></a>
File Creation</h1>
<p>There are two approaches to file creation. The first method is called the CreateCopy() method, and involves implementing a function that can write a file in the output format, pulling all imagery and other information needed from a source <a class="el" href="classGDALDataset.html" title="A set of associated raster bands, usually from one file. ">GDALDataset</a>. The second method, the dynamic creation method, involves implementing a Create method to create the shell of the file, and then the application writes various information by calls to set methods.</p>
<p>The benefits of the first method are that that all the information is available at the point the output file is being created. This can be especially important when implementing file formats using external libraries which require information like color maps, and georeferencing information at the point the file is created. The other advantage of this method is that the CreateCopy() method can read some kinds of information, such as min/max, scaling, description and GCPs for which there are no equivalent set methods.</p>
<p>The benefits of the second method are that applications can create an empty new file, and write results to it as they become available. A complete image of the desired data does not have to be available in advance.</p>
<p>For very important formats both methods may be implemented, otherwise do whichever is simpler, or provides the required capabilities.</p>
<h2><a class="anchor" id="gdal_drivertut_creation_createcopy"></a>
CreateCopy</h2>
<p>The <a class="el" href="classGDALDriver.html#a2c897da2a6e25169cccc49ef48797ce1" title="Create a copy of a dataset. ">GDALDriver::CreateCopy()</a> method call is passed through directly, so that method should be consulted for details of arguments. However, some things to keep in mind are:</p>
<ul>
<li>
<p class="startli">If the bStrict flag is FALSE the driver should try to do something reasonable when it cannot exactly represent the source dataset, transforming data types on the fly, dropping georeferencing and so forth.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Implementing progress reporting correctly is somewhat involved. The return result of the progress function needs always to be checked for cancellation, and progress should be reported at reasonable intervals. The JPEGCreateCopy() method demonstrates good handling of the progress function.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">Special creation options should be documented in the on-line help. If the options take the format "NAME=VALUE" the papszOptions list can be manipulated with CPLFetchNameValue() as demonstrated in the handling of the QUALITY and PROGRESSIVE flags for JPEGCreateCopy().</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">The returned <a class="el" href="classGDALDataset.html" title="A set of associated raster bands, usually from one file. ">GDALDataset</a> handle can be in ReadOnly or Update mode. Return it in Update mode if practical, otherwise in ReadOnly mode is fine.</p>
<p class="endli"></p>
</li>
</ul>
<p>The full implementation of the CreateCopy function for JPEG (which is assigned to pfnCreateCopy in the <a class="el" href="classGDALDriver.html" title="Format specific driver. ">GDALDriver</a> object) is here.</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <a class="code" href="classGDALDataset.html">GDALDataset</a> *</div>
<div class="line">JPEGCreateCopy( <span class="keyword">const</span> <span class="keywordtype">char</span> * pszFilename, <a class="code" href="classGDALDataset.html">GDALDataset</a> *poSrcDS,</div>
<div class="line">                <span class="keywordtype">int</span> bStrict, <span class="keywordtype">char</span> ** papszOptions,</div>
<div class="line">                GDALProgressFunc pfnProgress, <span class="keywordtype">void</span> * pProgressData )</div>
<div class="line"></div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> nBands = poSrcDS-&gt;<a class="code" href="classGDALDataset.html#a636b5086ec36ca97873833c20cd37bea">GetRasterCount</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> nXSize = poSrcDS-&gt;<a class="code" href="classGDALDataset.html#ab82b1dc1a187f5444dfcd6b0bb4448bf">GetRasterXSize</a>();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> nYSize = poSrcDS-&gt;<a class="code" href="classGDALDataset.html#af69445d483f2751fda614e3d79d50179">GetRasterYSize</a>();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Some some rudimentary checks</span></div>
<div class="line">    <span class="keywordflow">if</span>( nBands != 1 &amp;&amp; nBands != 3 )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="cpl__error_8h.html#afda4d86428c1c533449ae6a69cdf430d">CPLError</a>(CE_Failure, <a class="code" href="cpl__error_8h.html#a3a532186d9f9e2699aee57aab0648b5e">CPLE_NotSupported</a>,</div>
<div class="line">                 <span class="stringliteral">&quot;JPEG driver doesn&#39;t support %d bands.  Must be 1 (grey) &quot;</span></div>
<div class="line">                 <span class="stringliteral">&quot;or 3 (RGB) bands.&quot;</span>, nBands);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( poSrcDS-&gt;<a class="code" href="classGDALDataset.html#ad96adcf07f2979ad176e37a7f8638fb6">GetRasterBand</a>(1)-&gt;<a class="code" href="classGDALRasterBand.html#ae3ec3bfe18258dd73db3911fed97cc2e">GetRasterDataType</a>() != <a class="code" href="gdal_8h.html#a22e22ce0a55036a96f652765793fb7a4a38a66c26861d368e95ba42106ee3ab92">GDT_Byte</a> &amp;&amp; bStrict )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="cpl__error_8h.html#afda4d86428c1c533449ae6a69cdf430d">CPLError</a>(CE_Failure, <a class="code" href="cpl__error_8h.html#a3a532186d9f9e2699aee57aab0648b5e">CPLE_NotSupported</a>,</div>
<div class="line">                 <span class="stringliteral">&quot;JPEG driver doesn&#39;t support data type %s. &quot;</span></div>
<div class="line">                 <span class="stringliteral">&quot;Only eight bit byte bands supported.&quot;</span>,</div>
<div class="line">                 <a class="code" href="gdal_8h.html#a33b543bd0b1e36598abb7fa9fd39add7">GDALGetDataTypeName</a>(</div>
<div class="line">                     poSrcDS-&gt;<a class="code" href="classGDALDataset.html#ad96adcf07f2979ad176e37a7f8638fb6">GetRasterBand</a>(1)-&gt;<a class="code" href="classGDALRasterBand.html#ae3ec3bfe18258dd73db3911fed97cc2e">GetRasterDataType</a>()));</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// What options has the user selected?</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> nQuality = 75;</div>
<div class="line">    <span class="keywordflow">if</span>( <a class="code" href="cpl__string_8h.html#a94ca3f1c515330277c31b06d2a061ccd">CSLFetchNameValue</a>(papszOptions, <span class="stringliteral">&quot;QUALITY&quot;</span>) != NULL )</div>
<div class="line">    {</div>
<div class="line">        nQuality = atoi(<a class="code" href="cpl__string_8h.html#a94ca3f1c515330277c31b06d2a061ccd">CSLFetchNameValue</a>(papszOptions, <span class="stringliteral">&quot;QUALITY&quot;</span>));</div>
<div class="line">        <span class="keywordflow">if</span>( nQuality &lt; 10 || nQuality &gt; 100 )</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="cpl__error_8h.html#afda4d86428c1c533449ae6a69cdf430d">CPLError</a>(CE_Failure, <a class="code" href="cpl__error_8h.html#a07b0e6c2d300ba2d03743024b6fe109d">CPLE_IllegalArg</a>,</div>
<div class="line">                     <span class="stringliteral">&quot;QUALITY=%s is not a legal value in the range 10 - 100.&quot;</span>,</div>
<div class="line">                     <a class="code" href="cpl__string_8h.html#a94ca3f1c515330277c31b06d2a061ccd">CSLFetchNameValue</a>(papszOptions, <span class="stringliteral">&quot;QUALITY&quot;</span>));</div>
<div class="line">            <span class="keywordflow">return</span> NULL;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> bProgressive = <span class="keyword">false</span>;</div>
<div class="line">    <span class="keywordflow">if</span>( <a class="code" href="cpl__string_8h.html#a94ca3f1c515330277c31b06d2a061ccd">CSLFetchNameValue</a>(papszOptions, <span class="stringliteral">&quot;PROGRESSIVE&quot;</span>) != NULL )</div>
<div class="line">    {</div>
<div class="line">        bProgressive = <span class="keyword">true</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create the dataset.</span></div>
<div class="line">    <a class="code" href="cpl__vsi_8h.html#af1b1400e402360b38304de2b13d16c14">VSILFILE</a> *fpImage = <a class="code" href="cpl__vsi_8h.html#ae3cfa1605ce32e78fddb534bba7742f5">VSIFOpenL</a>(pszFilename, <span class="stringliteral">&quot;wb&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>( fpImage == NULL )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="cpl__error_8h.html#afda4d86428c1c533449ae6a69cdf430d">CPLError</a>(CE_Failure, <a class="code" href="cpl__error_8h.html#a730735f3bab3514071f6a8642910ea75">CPLE_OpenFailed</a>,</div>
<div class="line">                 <span class="stringliteral">&quot;Unable to create jpeg file %s.&quot;</span>,</div>
<div class="line">                 pszFilename);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Initialize JPG access to the file.</span></div>
<div class="line">    <span class="keyword">struct </span>jpeg_compress_struct sCInfo;</div>
<div class="line">    <span class="keyword">struct </span>jpeg_error_mgr sJErr;</div>
<div class="line"></div>
<div class="line">    sCInfo.err = jpeg_std_error(&amp;sJErr);</div>
<div class="line">    jpeg_create_compress(&amp;sCInfo);</div>
<div class="line"></div>
<div class="line">    jpeg_stdio_dest(&amp;sCInfo, fpImage);</div>
<div class="line"></div>
<div class="line">    sCInfo.image_width = nXSize;</div>
<div class="line">    sCInfo.image_height = nYSize;</div>
<div class="line">    sCInfo.input_components = nBands;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( nBands == 1 )</div>
<div class="line">    {</div>
<div class="line">        sCInfo.in_color_space = JCS_GRAYSCALE;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        sCInfo.in_color_space = JCS_RGB;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    jpeg_set_defaults(&amp;sCInfo);</div>
<div class="line"></div>
<div class="line">    jpeg_set_quality(&amp;sCInfo, nQuality, TRUE);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( bProgressive )</div>
<div class="line">        jpeg_simple_progression(&amp;sCInfo);</div>
<div class="line"></div>
<div class="line">    jpeg_start_compress(&amp;sCInfo, TRUE);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Loop over image, copying image data.</span></div>
<div class="line">    <a class="code" href="cpl__port_8h.html#ae7fbc84d3d1f7a40973be07382e28401">GByte</a> *pabyScanline = <span class="keyword">static_cast&lt;</span><a class="code" href="cpl__port_8h.html#ae7fbc84d3d1f7a40973be07382e28401">GByte</a> *<span class="keyword">&gt;</span>(<a class="code" href="cpl__conv_8h.html#a9a806de98fbddb1337efdb18651aa0f7">CPLMalloc</a>(nBands * nXSize));</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> iLine = 0; iLine &lt; nYSize; iLine++ )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">for</span>( <span class="keywordtype">int</span> iBand = 0; iBand &lt; nBands; iBand++ )</div>
<div class="line">        {</div>
<div class="line">            <a class="code" href="classGDALRasterBand.html">GDALRasterBand</a> * poBand = poSrcDS-&gt;<a class="code" href="classGDALDataset.html#ad96adcf07f2979ad176e37a7f8638fb6">GetRasterBand</a>(iBand + 1);</div>
<div class="line">            <span class="keyword">const</span> <a class="code" href="cpl__error_8h.html#a463ba7c7202a505416ff95b1aeefa2de">CPLErr</a> eErr =</div>
<div class="line">                poBand-&gt;<a class="code" href="classGDALRasterBand.html#a30786c81246455321e96d73047b8edf1">RasterIO</a>(<a class="code" href="gdal_8h.html#ae602fdf251b6b0210a5af5a7cf7623b3ab2abfe1fa6e34018b8c692eb48f35cb5">GF_Read</a>, 0, iLine, nXSize, 1,</div>
<div class="line">                                 pabyScanline + iBand, nXSize, 1, <a class="code" href="gdal_8h.html#a22e22ce0a55036a96f652765793fb7a4a38a66c26861d368e95ba42106ee3ab92">GDT_Byte</a>,</div>
<div class="line">                                 nBands, nBands * nXSize);</div>
<div class="line">            <span class="comment">// TODO: Handle error.</span></div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        JSAMPLE *ppSamples = pabyScanline;</div>
<div class="line">        jpeg_write_scanlines(&amp;sCInfo, &amp;ppSamples, 1);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <a class="code" href="cpl__conv_8h.html#a21b7f312da39ddb0a12bdde06b153b48">CPLFree</a>(pabyScanline);</div>
<div class="line"></div>
<div class="line">    jpeg_finish_compress(&amp;sCInfo);</div>
<div class="line">    jpeg_destroy_compress(&amp;sCInfo);</div>
<div class="line"></div>
<div class="line">    <a class="code" href="cpl__vsi_8h.html#ae7fe3eb9b2988c5a3c74889697f87e45">VSIFCloseL</a>(fpImage);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span><a class="code" href="classGDALDataset.html">GDALDataset</a> *<span class="keyword">&gt;</span>(<a class="code" href="gdal_8h.html#a6836f0f810396c5e45622c8ef94624d4">GDALOpen</a>(pszFilename, <a class="code" href="gdal_8h.html#a045e3967c208993f70257bfd40c9f1d7a5a021a550b9d5640307d3c0e7e35b732">GA_ReadOnly</a>));</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="gdal_drivertut_creation_create"></a>
Dynamic Creation</h2>
<p>In the case of dynamic creation, there is no source dataset. Instead the size, number of bands, and pixel data type of the desired file is provided but other information (such as georeferencing, and imagery data) would be supplied later via other method calls on the resulting <a class="el" href="classGDALDataset.html" title="A set of associated raster bands, usually from one file. ">GDALDataset</a>.</p>
<p>The following sample implement PCI .aux labeled raw raster creation. It follows a common approach of creating a blank, but valid file using non-GDAL calls, and then calling GDALOpen(,GA_Update) at the end to return a writable file handle. This avoids having to duplicate the various setup actions in the Open() function.</p>
<div class="fragment"><div class="line"><a class="code" href="classGDALDataset.html">GDALDataset</a> *PAuxDataset::Create( <span class="keyword">const</span> <span class="keywordtype">char</span> * pszFilename,</div>
<div class="line">                                  <span class="keywordtype">int</span> nXSize, <span class="keywordtype">int</span> nYSize, <span class="keywordtype">int</span> nBands,</div>
<div class="line">                                  <a class="code" href="gdal_8h.html#a22e22ce0a55036a96f652765793fb7a4">GDALDataType</a> eType,</div>
<div class="line">                                  <span class="keywordtype">char</span> ** <span class="comment">/* papszParmList */</span> )</div>
<div class="line"></div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Verify input options.</span></div>
<div class="line">    <span class="keywordflow">if</span>( eType != <a class="code" href="gdal_8h.html#a22e22ce0a55036a96f652765793fb7a4a38a66c26861d368e95ba42106ee3ab92">GDT_Byte</a> &amp;&amp; eType != <a class="code" href="gdal_8h.html#a22e22ce0a55036a96f652765793fb7a4af5cbd2f96abffd9ac061fc0dced5cbba">GDT_Float32</a> &amp;&amp;</div>
<div class="line">        eType != <a class="code" href="gdal_8h.html#a22e22ce0a55036a96f652765793fb7a4ab8eec11a9f30464690e2602cca2ac5d5">GDT_UInt16</a> &amp;&amp; eType != <a class="code" href="gdal_8h.html#a22e22ce0a55036a96f652765793fb7a4acd01d1afd29ffdb9a1cc6c09de61fd2b">GDT_Int16</a> )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="cpl__error_8h.html#afda4d86428c1c533449ae6a69cdf430d">CPLError</a>(</div>
<div class="line">            CE_Failure, <a class="code" href="cpl__error_8h.html#a7151d0699caa1372a8566562390ff113">CPLE_AppDefined</a>,</div>
<div class="line">            <span class="stringliteral">&quot;Attempt to create PCI .Aux labeled dataset with an illegal &quot;</span></div>
<div class="line">            <span class="stringliteral">&quot;data type (%s).&quot;</span>,</div>
<div class="line">            <a class="code" href="gdal_8h.html#a33b543bd0b1e36598abb7fa9fd39add7">GDALGetDataTypeName</a>(eType));</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Try to create the file.</span></div>
<div class="line">    FILE *fp = VSIFOpen(pszFilename, <span class="stringliteral">&quot;w&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span>( fp == NULL )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="cpl__error_8h.html#afda4d86428c1c533449ae6a69cdf430d">CPLError</a>(CE_Failure, <a class="code" href="cpl__error_8h.html#a730735f3bab3514071f6a8642910ea75">CPLE_OpenFailed</a>,</div>
<div class="line">                 <span class="stringliteral">&quot;Attempt to create file `%s&#39; failed.&quot;</span>,</div>
<div class="line">                 pszFilename);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Just write out a couple of bytes to establish the binary</span></div>
<div class="line">    <span class="comment">// file, and then close it.</span></div>
<div class="line">    VSIFWrite(<span class="stringliteral">&quot;\0\0&quot;</span>, 2, 1, fp);</div>
<div class="line">    VSIFClose(fp);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create the aux filename.</span></div>
<div class="line">    <span class="keywordtype">char</span> *pszAuxFilename = <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span> *<span class="keyword">&gt;</span>(<a class="code" href="cpl__conv_8h.html#a9a806de98fbddb1337efdb18651aa0f7">CPLMalloc</a>(strlen(pszFilename) + 5));</div>
<div class="line">    strcpy(pszAuxFilename, pszFilename);;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = strlen(pszAuxFilename) - 1; i &gt; 0; i-- )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span>( pszAuxFilename[i] == <span class="charliteral">&#39;.&#39;</span> )</div>
<div class="line">        {</div>
<div class="line">            pszAuxFilename[i] = <span class="charliteral">&#39;\0&#39;</span>;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    strcat(pszAuxFilename, <span class="stringliteral">&quot;.aux&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Open the file.</span></div>
<div class="line">    fp = VSIFOpen(pszAuxFilename, <span class="stringliteral">&quot;wt&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span>( fp == NULL )</div>
<div class="line">    {</div>
<div class="line">        <a class="code" href="cpl__error_8h.html#afda4d86428c1c533449ae6a69cdf430d">CPLError</a>(CE_Failure, <a class="code" href="cpl__error_8h.html#a730735f3bab3514071f6a8642910ea75">CPLE_OpenFailed</a>,</div>
<div class="line">                 <span class="stringliteral">&quot;Attempt to create file `%s&#39; failed.&quot;</span>,</div>
<div class="line">                 pszAuxFilename);</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// We need to write out the original filename but without any</span></div>
<div class="line">    <span class="comment">// path components in the AuxiliaryTarget line.  Do so now.</span></div>
<div class="line">    <span class="keywordtype">int</span> iStart = strlen(pszFilename) - 1;</div>
<div class="line">    <span class="keywordflow">while</span>( iStart &gt; 0 &amp;&amp; pszFilename[iStart - 1] != <span class="charliteral">&#39;/&#39;</span> &amp;&amp;</div>
<div class="line">           pszFilename[iStart - 1] != <span class="charliteral">&#39;\\&#39;</span> )</div>
<div class="line">        iStart--;</div>
<div class="line"></div>
<div class="line">    VSIFPrintf(fp, <span class="stringliteral">&quot;AuxilaryTarget: %s\n&quot;</span>, pszFilename + iStart);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Write out the raw definition for the dataset as a whole.</span></div>
<div class="line">    VSIFPrintf(fp, <span class="stringliteral">&quot;RawDefinition: %d %d %d\n&quot;</span>,</div>
<div class="line">               nXSize, nYSize, nBands);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Write out a definition for each band.  We always write band</span></div>
<div class="line">    <span class="comment">// sequential files for now as these are pretty efficiently</span></div>
<div class="line">    <span class="comment">// handled by GDAL.</span></div>
<div class="line">    <span class="keywordtype">int</span> nImgOffset = 0;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> iBand = 0; iBand &lt; nBands; iBand++ )</div>
<div class="line">    {</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> nPixelOffset = <a class="code" href="gdal_8h.html#add716a80fb41b4140fc6fb6a703ac992">GDALGetDataTypeSize</a>(eType)/8;</div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">int</span> nLineOffset = nXSize * nPixelOffset;</div>
<div class="line"></div>
<div class="line">        <span class="keyword">const</span> <span class="keywordtype">char</span> *pszTypeName = NULL;</div>
<div class="line">        <span class="keywordflow">if</span>( eType == <a class="code" href="gdal_8h.html#a22e22ce0a55036a96f652765793fb7a4af5cbd2f96abffd9ac061fc0dced5cbba">GDT_Float32</a> )</div>
<div class="line">            pszTypeName = <span class="stringliteral">&quot;32R&quot;</span>;</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( eType == <a class="code" href="gdal_8h.html#a22e22ce0a55036a96f652765793fb7a4acd01d1afd29ffdb9a1cc6c09de61fd2b">GDT_Int16</a> )</div>
<div class="line">            pszTypeName = <span class="stringliteral">&quot;16S&quot;</span>;</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span>( eType == <a class="code" href="gdal_8h.html#a22e22ce0a55036a96f652765793fb7a4ab8eec11a9f30464690e2602cca2ac5d5">GDT_UInt16</a> )</div>
<div class="line">            pszTypeName = <span class="stringliteral">&quot;16U&quot;</span>;</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">            pszTypeName = <span class="stringliteral">&quot;8U&quot;</span>;</div>
<div class="line"></div>
<div class="line">        VSIFPrintf( fp, <span class="stringliteral">&quot;ChanDefinition-%d: %s %d %d %d %s\n&quot;</span>,</div>
<div class="line">                    iBand + 1, pszTypeName,</div>
<div class="line">                    nImgOffset, nPixelOffset, nLineOffset,</div>
<div class="line">#ifdef CPL_LSB</div>
<div class="line">                    <span class="stringliteral">&quot;Swapped&quot;</span></div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">                    <span class="stringliteral">&quot;Unswapped&quot;</span></div>
<div class="line">#endif</div>
<div class="line">                    );</div>
<div class="line"></div>
<div class="line">        nImgOffset += nYSize * nLineOffset;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Cleanup.</span></div>
<div class="line">    VSIFClose(fp);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span><a class="code" href="classGDALDataset.html">GDALDataset</a> *<span class="keyword">&gt;</span>(<a class="code" href="gdal_8h.html#a6836f0f810396c5e45622c8ef94624d4">GDALOpen</a>(pszFilename, <a class="code" href="gdal_8h.html#a045e3967c208993f70257bfd40c9f1d7a61c6081de474ef2a756982d3c53130a2">GA_Update</a>));</div>
<div class="line">}</div>
</div><!-- fragment --><p>File formats supporting dynamic creation, or even just update-in-place access also need to implement an IWriteBlock() method on the raster band class. It has semantics similar to IReadBlock(). As well, for various esoteric reasons, it is critical that a FlushCache() method be implemented in the raster band destructor. This is to ensure that any write cache blocks for the band be flushed out before the destructor is called.</p>
<h1><a class="anchor" id="gdal_drivertut_raw"></a>
RawDataset/RawRasterBand Helper Classes</h1>
<p>Many file formats have the actual imagery data stored in a regular, binary, scanline oriented format. Rather than re-implement the access semantics for this for each formats, there are provided RawDataset and RawRasterBand classes declared in gdal/frmts/raw that can be utilized to implement efficient and convenient access.</p>
<p>In these cases the format specific band class may not be required, or if required it can be derived from RawRasterBand. The dataset class should be derived from RawDataset.</p>
<p>The Open() method for the dataset then instantiates raster bands passing all the layout information to the constructor. For instance, the PNM driver uses the following calls to create it's raster bands.</p>
<div class="fragment"><div class="line"><span class="keywordflow">if</span>( poOpenInfo-&gt;<a class="code" href="classGDALOpenInfo.html#a2193ea49d916003baa90e75426309e10">pabyHeader</a>[1] == <span class="charliteral">&#39;5&#39;</span> )</div>
<div class="line">{</div>
<div class="line">    poDS-&gt;SetBand(</div>
<div class="line">        1, <span class="keyword">new</span> RawRasterBand(poDS, 1, poDS-&gt;fpImage,</div>
<div class="line">                             iIn, 1, nWidth, <a class="code" href="gdal_8h.html#a22e22ce0a55036a96f652765793fb7a4a38a66c26861d368e95ba42106ee3ab92">GDT_Byte</a>, TRUE));</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span></div>
<div class="line">{</div>
<div class="line">    poDS-&gt;SetBand(</div>
<div class="line">        1, <span class="keyword">new</span> RawRasterBand(poDS, 1, poDS-&gt;fpImage,</div>
<div class="line">                             iIn, 3, nWidth*3, <a class="code" href="gdal_8h.html#a22e22ce0a55036a96f652765793fb7a4a38a66c26861d368e95ba42106ee3ab92">GDT_Byte</a>, TRUE));</div>
<div class="line">    poDS-&gt;SetBand(</div>
<div class="line">        2, <span class="keyword">new</span> RawRasterBand(poDS, 2, poDS-&gt;fpImage,</div>
<div class="line">                             iIn+1, 3, nWidth*3, <a class="code" href="gdal_8h.html#a22e22ce0a55036a96f652765793fb7a4a38a66c26861d368e95ba42106ee3ab92">GDT_Byte</a>, TRUE));</div>
<div class="line">    poDS-&gt;SetBand(</div>
<div class="line">        3, <span class="keyword">new</span> RawRasterBand(poDS, 3, poDS-&gt;fpImage,</div>
<div class="line">                             iIn+2, 3, nWidth*3, <a class="code" href="gdal_8h.html#a22e22ce0a55036a96f652765793fb7a4a38a66c26861d368e95ba42106ee3ab92">GDT_Byte</a>, TRUE));</div>
<div class="line">}</div>
</div><!-- fragment --><p>The RawRasterBand takes the following arguments.</p>
<ul>
<li>
<b>poDS</b>: The <a class="el" href="classGDALDataset.html" title="A set of associated raster bands, usually from one file. ">GDALDataset</a> this band will be a child of. This dataset must be of a class derived from RawRasterDataset. </li>
<li>
<b>nBand</b>: The band it is on that dataset, 1 based. </li>
<li>
<b>fpRaw</b>: The FILE * handle to the file containing the raster data. </li>
<li>
<b>nImgOffset</b>: The byte offset to the first pixel of raster data for the first scanline. </li>
<li>
<b>nPixelOffset</b>: The byte offset from the start of one pixel to the start of the next within the scanline. </li>
<li>
<b>nLineOffset</b>: The byte offset from the start of one scanline to the start of the next. </li>
<li>
<b>eDataType</b>: The GDALDataType code for the type of the data on disk. </li>
<li>
<b>bNativeOrder</b>: FALSE if the data is not in the same endianness as the machine GDAL is running on. The data will be automatically byte swapped. </li>
</ul>
<p>Simple file formats utilizing the Raw services are normally placed all within one file in the gdal/frmts/raw directory. There are numerous examples there of format implementation.</p>
<h1><a class="anchor" id="gdal_drivertut_metadata"></a>
Metadata, and Other Exotic Extensions</h1>
<p>There are various other items in the GDAL data model, for which virtual methods exist on the <a class="el" href="classGDALDataset.html" title="A set of associated raster bands, usually from one file. ">GDALDataset</a> and <a class="el" href="classGDALRasterBand.html" title="A single raster band (or channel). ">GDALRasterBand</a>. They include:</p>
<ul>
<li>
<p class="startli"><b>Metadata</b>: Name/value text values about a dataset or band. The <a class="el" href="classGDALMajorObject.html" title="Object with metadata. ">GDALMajorObject</a> (base class for <a class="el" href="classGDALRasterBand.html" title="A single raster band (or channel). ">GDALRasterBand</a> and <a class="el" href="classGDALDataset.html" title="A set of associated raster bands, usually from one file. ">GDALDataset</a>) has built-in support for holding metadata, so for read access it only needs to be set with calls to SetMetadataItem() during the Open(). The SAR_CEOS (frmts/ceos2/sar_ceosdataset.cpp) and GeoTIFF drivers are examples of drivers implementing readable metadata.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><b>ColorTables</b>: GDT_Byte raster bands can have color tables associated with them. The frmts/png/pngdataset.cpp driver contains an example of a format that supports colortables.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><b>ColorInterpretation</b>: The PNG driver contains an example of a driver that returns an indication of whether a band should be treated as a Red, Green, Blue, Alpha or Greyscale band.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><b>GCPs</b>: GDALDatasets can have a set of ground control points associated with them (as opposed to an explicit affine transform returned by GetGeotransform()) relating the raster to georeferenced coordinates. The MFF2 (gdal/frmts/raw/hkvdataset.cpp) format is a simple example of a format supporting GCPs.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><b>NoDataValue</b>: Bands with known "nodata" values can implement the GetNoDataValue() method. See the PAux (frmts/raw/pauxdataset.cpp) for an example of this.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><b>Category Names</b>: Classified images with names for each class can return them using the GetCategoryNames() method though no formats currently implement this.</p>
<p class="endli"></p>
</li>
</ul>
<p> 
<p>
$Id$
</p>
 </p>
</div></div><!-- contents -->
<hr>
Generated for GDAL by
<a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.8.8.
</body>
</html>
